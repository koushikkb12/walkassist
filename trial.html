<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Assistant for Blind Users</title>
    <style>
        /* Add this new style for permission prompts */
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .permission-box {
            background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .permission-box h2 {
            color: #1a2a6c;
            margin-bottom: 15px;
        }
        
        .permission-box ol {
            text-align: left;
            margin: 20px 0;
        }
        
        .permission-box li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Add this permission overlay at the top of your body -->
    <div id="permissionOverlay" class="permission-overlay" style="display: flex;">
        <div class="permission-box">
            <h2>Permission Required</h2>
            <p>This app needs camera and microphone access to work properly.</p>
            <ol>
                <li>Click "Allow" when prompted for permissions</li>
                <li>If you accidentally denied, follow these steps:</li>
                <ol type="a">
                    <li>Tap the lock icon in address bar</li>
                    <li>Select "Site settings"</li>
                    <li>Enable Camera and Microphone</li>
                    <li>Refresh this page</li>
                </ol>
            </ol>
            <button id="grantPermissionBtn" style="padding: 12px 24px; background: #4a54e1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                Grant Permissions
            </button>
        </div>
    </div>

    <!-- Your existing HTML content here -->
    <div class="container" style="display: none;">
        <!-- ... your existing content ... -->
    </div>

    <script>
        // Enhanced permission handling
        const permissionOverlay = document.getElementById('permissionOverlay');
        const grantPermissionBtn = document.getElementById('grantPermissionBtn');
        const mainContainer = document.querySelector('.container');

        async function initializeWithPermissions() {
            try {
                // Request camera access first
                const cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // Then request microphone access
                const microphoneStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                // If we get here, permissions are granted
                permissionOverlay.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                // Initialize your app
                initApp();
                
            } catch (error) {
                console.error('Permission denied:', error);
                
                // Show detailed instructions
                permissionOverlay.innerHTML = `
                    <div class="permission-box">
                        <h2>Permissions Denied</h2>
                        <p>To fix this on Android:</p>
                        <ol>
                            <li><strong>Chrome Browser:</strong></li>
                            <ol type="a">
                                <li>Tap the <strong>lock icon</strong> in the address bar</li>
                                <li>Select <strong>"Site settings"</strong></li>
                                <li>Enable <strong>Camera</strong> and <strong>Microphone</strong></li>
                                <li>Refresh this page</li>
                            </ol>
                            <li><strong>Alternative method:</strong></li>
                            <ol type="a">
                                <li>Open Chrome Settings â†’ Site Settings</li>
                                <li>Find Camera/Microphone sections</li>
                                <li>Allow permissions for this site</li>
                            </ol>
                        </ol>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: #4a54e1; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
                            Reload Page
                        </button>
                        <button onclick="initializeWithPermissions()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Request permissions on button click
        grantPermissionBtn.addEventListener('click', initializeWithPermissions);

        // Your existing initApp function
        async function initApp() {
            // Move your existing initialization code here
            // This is where you load TensorFlow, set up camera, etc.
            console.log('App initialized with permissions!');
            
            // Your existing initialization code goes here...
            try {
                // Load the COCO-SSD model
                model = await cocoSsd.load();
                
                // Set up camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                video.srcObject = stream;
                // ... rest of your initialization
            } catch (error) {
                console.error('Error initializing app:', error);
            }
        }

        // Also try initializing on page load (some browsers allow this)
        window.addEventListener('load', function() {
            // Some Android devices allow auto-initialization
            setTimeout(initializeWithPermissions, 1000);
        });
    </script>
</body>
</html>